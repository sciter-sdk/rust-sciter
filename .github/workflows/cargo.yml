name: Build-n-Test

on:
  push:
    branches:
    - master
    - travis

  pull_request:
    branches:
    - master

jobs:
  fetch:
    name: Fetch dependencies

    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        # macOS doesn't have Rust installed
        # https://help.github.com/en/actions/automating-your-workflow-with-github-actions/software-installed-on-github-hosted-runners#macos-1015
        os: [macos-latest, ubuntu-latest, windows-latest]

    steps:
      - name: Environment
        shell: bash
        env:
          RUNNER_CONTEXT: ${{ toJson(runner) }}
        run: |
          echo HOME is "$HOME"
          echo workspace is "$GITHUB_WORKSPACE"
          echo temp is "$TEMP"
          echo runner is "$RUNNER_CONTEXT"
          echo cargo is at `which cargo`
          echo rustc is at `which rustc`
          command -v cargo && rustc -vV
          echo done

      - name: Windows deps
        if: runner.os == 'Windows'
        run: curl -sSLo "%GITHUB_WORKSPACE%/sciter.dll" "https://raw.githubusercontent.com/c-smile/sciter-sdk/master/bin.win/x64/sciter.dll"
        shell: cmd

      - name: Linux deps
        if: runner.os == 'Linux'
        run: |
          curl -so "$GITHUB_WORKSPACE/libsciter-gtk.so" "https://raw.githubusercontent.com/c-smile/sciter-sdk/master/bin.lnx/x64/libsciter-gtk.so"
          sudo apt-get install libgtk-3-dev libgtk-3-0 libstdc++-6-pic -y

      - name: macOS deps
        if: runner.os == 'macOS'
        run: |
          curl -so "$GITHUB_WORKSPACE/sciter-osx-64.dylib" "https://raw.githubusercontent.com/c-smile/sciter-sdk/master/bin.osx/sciter-osx-64.dylib"
          curl https://sh.rustup.rs -sSf | sh -s -- --profile minimal -y
          echo cargo is at `which cargo`
          echo rustc is at `which rustc`

  build:
    needs: [fetch]
    name: Build and test

    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
    - uses: actions/checkout@v2

    - name: Build
      run: |
        cargo build --release --all
        cargo build --release --examples

    - name: Tests
      run: cargo test --all
